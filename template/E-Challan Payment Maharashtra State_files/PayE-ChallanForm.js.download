var pageContext;
$(document)
	.ready(
		function() {

			var sliptVal = $('#homePageContext').val().split('[');
			//			alert("Before "+sliptVal);
			var newSliptVal = sliptVal[1].split(']');
			//			alert(newSliptVal[0]);
			pageContext = newSliptVal[0].split(',');

			$(window).load(resetval);
			if ($('input[name=challanCategory]:checked').val() == 'CHNO') {
				$("#chassiId").hide();
				change();
			}
			if ($('#isImp').val() == 'true') {
				$('input:checkbox').prop('checked', true);
				$('input:checkbox').css('display', 'none');
				$('#btnpopup').text("Pay All");

			} else {
			}
			$('#checkbox').click(function() {
				if ($(this).prop("checked") == true) {
					$('input:checkbox').prop('checked', true);
				}
				else {
					$('input:checkbox').prop('checked', false);
				}
			});

			if ($('input[name=challanCategory]:checked').val() == 'VNO') {
				$("#chassiId").show();
				//$('#linkmobile').show();
			} else {
				$("#chassiId").hide();
				$('#linkmobile').hide();
			}

			$("#challanId,#vehicleId")
				.click(
					function() {
						if ($(
							'input[name=challanCategory]:checked')
							.val() == 'VNO') {
							$('#linkmobile').show();
							$("#chassiId").show();
							$("#txt").val("");
							$('#searchErr').text("");
							$('#invalidCaptchaErr').text("");
						} else {
							$('#linkmobile').hide();
							$("#txt").val("");
							$("#chassiId").hide();
							$('#searchErr').text("");
							$('#emptyChassiErr').text("");
							$("#chassiId").val("");
							$('#invalidCaptchaErr').text("");
						}
					});

			$("#refreshCaptchaId").click(function() {
				location.reload();
				e.preventDefault();
			});


			$("#payBtn")
				.click(
					function() {
						try {
							$('#errr').text("");
							$('#licLbl').text("");
							$('#txtLicense').val("");
							$("#licenserr").text("");
							$('#selectedOffence').empty();
							var licNos = new Array();
							var headerIds = new Array();
							$(
								"input:checkbox[name=challans]:checked")
								.each(
									function() {
										licNos
											.push($(
												this)
												.attr(
													"dlno"));
										headerIds
											.push($(
												this)
												.val())
									});

							if (licNos.length <= 0) {
								$('#errr')
									.text(
										"Please select at least 1 challan no.");
								return false;
							}
							//adding header ids to hidden fields
							for (var j = 0; j < headerIds.length; j++) {
								$('#selectedOffence')
									.append(
										"<input type='checkbox' value='" + headerIds[j] + "' name='offences' style='visibility:hidden;' checked >");
							}
							if (licNos.length == 1) {
								if (licNos[0].length < 15) {
									$('#licenceNo').modal();
									return false;
								} else {
									return true;
								}
							} else {
								var allValid = checkAllValid(licNos);
								if (allValid) {
									return true;
								} else {
									var allInvalid = checkAllInvalid(licNos);
									if (allInvalid) {
										$('#licLbl')
											.text(
												"This license number will be updated against all ("
												+ licNos.length
												+ ") challan Nos. ");
										$('#licenceNo')
											.modal();

										return false;
									} else {
										var sameWithNull = checkSameWithNull(licNos);
										if (sameWithNull) {
											$('#licLbl')
												.text(
													"This license number will be updated against all ("
													+ licNos.length
													+ ") challan Nos.");
											$('#txtLicense')
												.val(
													getLicenseNo(licNos));
											$('#licenceNo')
												.modal();
											return false;
										} else {
											$('#DiffLicMsg')
												.modal();
											return false;
										}
									}
								}
							}
						} catch (e) {
							alert(e.message);
						}
					});

			$('#backBtn').click(function() {
				history.go(-1);
			});
			$('#frm').keypress(function(e) {
				if (e.which == 13) {
					e.preventDefault();
				}
			});

			var a = $(window).height();
			var b = (a - 120) / 2;
			$("#screen").css("margin-top", b + "px");
			$("#licenceNo").css("margin-top", b + "px");
			$("#confirmotpdialog").css("display", "none");
			$("#loader").css("display", "none");
			$("#loader1").css("display", "none");

			$("#cancle").click(function() {
				$(".close").click();
			});
			$("#crfm").click(function() {
				$(".close").click();
			});

			$("#subbtn")
				.click(
					function() {
						$('#emptyNumber').text("");
						var a = $(
							"input[name='challanCategory']:checked")
							.val().trim();
						var b = $("#txt").val().trim();

						if (b == "") {
							if (a == "VNO"
								|| b.length != 10) {
								$('#emptyNumber')
									.text(
										"Enter Valid Vehicle No. 'AB00AB0000'");
							}
							if (a == "CHNO") {
								$('#emptyNumber')
									.text(
										"Enter Challan NO.");
							}
							return false;
						}
						$('#loader1').css("display",
							"block");
						$
							.ajax(
								{
									type: "POST",
									url: "getMobileNo.htm?categoryType="
										+ a
										+ "&categoryNumber="
										+ b
								})
							.done(
								function(a) {
									$('#loader1')
										.css(
											"display",
											"none");
									var text = JSON
										.stringify(a);
									var obj = JSON
										.parse(text);
									$("#screen")
										.modal();
									$(
										'#vehicleNumber')
										.val(
											obj.vehicleNo);
								})
							.fail(
								function() {
									$('#loader1')
										.css(
											"display",
											"none");
								});
					});

			$("#changeNo").click(function() {
				$('#newnumber').removeAttr("disabled");

			});

			$('#sendOTP')
				.click(
					function() {

						$("#phonenoerr").text("");
						var res = true;
						var phoneno = /^\d{10}$/;

						var no = $('#newnumber').val();
						if (no.length != 10
							|| !no.match(phoneno)) {
							$("#phonenoerr").text(
								"Invalid Phone No.");
							return false;
						}
						$('#loader')
							.css("display", "block");
						$
							.ajax(
								{
									type: "POST",
									url: "sendOTP.htm?mobileNoNew="
										+ no

								})
							.done(
								function(result) {
									if (result == "success") {
										$('#loader')
											.css(
												"display",
												"none");
										$(
											'#confirmotpdialog')
											.css(
												"display",
												"block");

										$(
											'#sendotp')
											.css(
												"display",
												"none");
									} else {
										$('#loader').css("display", "none");
										alert("Fail to send otp");
									}

								})
							.fail(
								function() {
									$('#loader').css("display", "none");
									alert("Fail to send otp");
								});

					});

			$('#licenseCancel')
				.click(
					function() {
						var challan = $('#headerId').val().trim();
						window.location = "policypage.htm?ChallanNo=" + challan;
						$('.close').click();

					});

			$('#saveLicense')
				.click(
					function() {

						var licno = $('#LicenseNo').val().trim();
						var headerid = $('#headerId').val().trim();

						if (licno.length != 15) {
							$('#licenserr')
								.text("Enter Correct License No.");
							return false;
						}

						$('#loader3').css("display", "block");
						$
							.ajax(
								{
									type: "POST",
									url: "updateLic.htm?lic="
										+ licno
										+ "&headerid="
										+ headerid

								})
							.done(
								function(result) {
									if (result == "success") {
										$('#loader')
											.css("display", "none");

										$('.close').click();
										var challan = $('#headerId').val().trim();
										window.location = "policypage.htm?ChallanNo=" + challan;

									} else {
										$('#loader')
											.css("display", "none");
										$('.close').click();
									}
								})
							.fail(
								function() {
									$('#loader').css("display", "none");
									$('.close').click();

								});
					});

			$('#confirmOTP')
				.click(
					function() {
						var enteredOTP = $("#EnteredOPT")
							.val().trim();
						var no = $("#newnumber").val();
						if (enteredOTP == ""
							|| enteredOTP == null) {
							$("#err").text(
								"Enter OTP Correctly.");
							return false;
						}
						$('#loader')
							.css("display", "block");
						$
							.ajax(
								{
									type: "POST",
									url: "confirmOTP.htm?mobileNoNew="
										+ no
										+ "&enteredOTP="
										+ enteredOTP
										+ "&vehicleNo="
										+ $(
											'#vehicleNumber')
											.val()
											.trim()
								})
							.done(
								function(result) {
									if (result == "success") {
										$('#loader')
											.css(
												"display",
												"none");

										$(
											'#confirmotpdialog')
											.css(
												"display",
												"none");

										$(
											'#databtn')
											.click();

									} else {
										$('#loader')
											.css(
												"display",
												"none");
										$("#err")
											.text(
												"Enter Correct OTP.");
									}

								})
							.fail(
								function(result) {
									$('#loader')
										.css(
											"display",
											"none");
								});
					});

			$('[data-toggle="tooltip"]').tooltip();
			var c = "${ChallanNo}";
			var d = "${downloadEchallan}";
			//			if (null != c && d)
			//				window.location = "ChallanPDF.htm?${cipherUtils.encrypt(pageContext.request,'ChallanNo='.concat(ChallanNo))}";

		});

function resetval() {
	$("#txt").val("");
	$("#chassiId").val("");
	$('#invalidCaptchaErr').text("");
	//	document.getElementById("#enteredCaptcha").innerText('');
	$('#enteredCaptcha').text("");
	//document.getElementById("#enteredCaptcha").innerText('');
}

$(function() {
	$('#btnpopup').attr('disabled', false);
})

function changeplh() {
	var textbx = $('#vehicleId').val();
	if (textbx == 'VNO') {
		//		$("#txt").attr("placeholder", "${homePageContext.inputvehicletext}");
		$("#txt").attr("placeholder", pageContext[3].split('=')[1]);
	}
}

function change() {
	var textbx = $('#challanId').val();
	if (textbx == 'CHNO') {
		//		$("#txt").attr("placeholder", "${homePageContext.inputchallantext}");
		$("#txt").attr("placeholder", pageContext[7].split('=')[1]);
	}
}
function instructions() {
	$("#instructions").modal();
}
function checkAllValid(licenseNos) {
	var isAllValid = true;
	for (var i = 0; i < licenseNos.length; i++) {
		if (licenseNos[i].length < 15) {
			isAllValid = false;
		}
	}
	return isAllValid;
}
function checkAllInvalid(licenseNos) {
	var isAllInValid = true;
	for (var i = 0; i < licenseNos.length; i++) {
		if (licenseNos[i].length = 15) {
			isAllInValid = false;
		}
	}
	return isAllInValid;
}
function checkSameWithNull(licenseNos) {
	var isContainNull = false;
	var isSame = true;
	var validLicNos = new Array();
	for (var j = 0; j < licenseNos.length; j++) {
		if (licenseNos[j].length < 15) {
			true;
		} else {
			validLicNos.push(licenseNos[j]);
		}
	}
	for (var i = 0; i < validLicNos.length; i++) {
		for (var k = 0; k < validLicNos.length; k++) {
			if (i != k) {
				if (validLicNos[i] != validLicNos[k]) {
					isSame = false;
				}
			}
		}
	}
	return isSame;
}


function getLicenseNo(licenseNos) {
	var isContainNull = false;
	var isSame = true;
	var validLicNos = new Array();
	for (var j = 0; j < licenseNos.length; j++) {
		if (licenseNos[j].length < 15) {
			true;
		} else {
			validLicNos.push(licenseNos[j]);
		}
	}
	for (var i = 0; i < validLicNos.length; i++) {
		for (var k = 0; k < validLicNos.length; k++) {
			if (i != k) {
				if (validLicNos[i] != validLicNos[k]) {
					isSame = false;
				}
			}
		}
	}
	return validLicNos[0];
}

$(window).bind("pageshow", function() {
	var $radios = $('input:radio[name=challanCategory]');
	$radios.filter('[value="VNO"]').prop('checked', true);
	$("#chassiId").val('');
	$("#vehicleId").trigger("click");

});

function ReadMoreFunction() {

	//	if ($('#readMore').text() == 'Read More') {
	if ($('#readMore').text() == pageContext[15].split('=')[1]) {
		$('#info').css({ 'height': 'auto' });
		//		document.getElementById('readMore').innerHTML = "Read Less";
		document.getElementById('readMore').innerHTML = pageContext[16].split('=')[1];
		//	} else if ($('#readMore').text() == 'Read Less') {
	} else if ($('#readMore').text() == pageContext[16].split('=')[1]) {
		$('#info').css({ 'height': '55px' });
		//		document.getElementById('readMore').innerHTML = "Read More";
		document.getElementById('readMore').innerHTML = pageContext[15].split('=')[1];
	}
}

function validator() {
	$('#invalidCaptchaErr').text("");
	$('#searchErr').text("");
	$('#emptyChassiErr').text("");
	var response = false;
	if ($('#txt').val().trim() == "") {
		if ($('input[name=challanCategory]:checked').val() == 'VNO') {
			//							$('#searchErr').text("${homePageContext.inputvehiclemsgtext}");
			$('#searchErr').text(pageContext[4].split('=')[1]);
		} else {
			//							$('#searchErr').text("${homePageContext.inputchallanmsgtext}");
			$('#searchErr').text(pageContext[8].split('=')[1]);
		}
		return false;
	} else {
		if ($('input[name=challanCategory]:checked').val() == 'VNO') {

			if ($('#chassiId').val().trim() == "") {
				//										$('#emptyChassiErr').text("${homePageContext.intputvehiclechessisenginemsg}");
				//				alert(pageContext[5].split('=')[1]);
				$('#emptyChassiErr').text(pageContext[6].split('=')[1]);
				return false;
			} else if ($('#enteredCaptcha').val().trim() == "") {
				//											$('#invalidCaptchaErr').text("${homePageContext.inputcodetext}");
				$('#invalidCaptchaErr').text(pageContext[9].split('=')[1]);
				return false;

			}

		} else if ($('#enteredCaptcha').val().trim() == "") {
			//			$('#invalidCaptchaErr').text("${homePageContext.inputcodetext}");
			$('#invalidCaptchaErr').text(pageContext[9].split('=')[1]);
			return false;
		}
	}
	
	
}

